package fetcher

import (
	"strings"
	"github.com/PuerkitoBio/goquery"
	"github.com/mozqnet/go-exploitdb/models"
)

func FetchCveExploitId() ([]models.EdbIdCve, error) {
        url := "http://cve.mitre.org/data/refs/refmap/source-EXPLOIT-DB.html"
        doc, _ := goquery.NewDocument(url)

	var result []models.EdbIdCve
	var r models.EdbIdCve
	is_first := true

	doc.Find("td").Each(func(_ int, s *goquery.Selection) {
		td_item_str := s.Text()
		if strings.Contains(td_item_str, "EXPLOIT-DB:") {
			edbid := td_item_str
			edbid = strings.Replace(edbid, "EXPLOIT-DB:", "", 1)
			if is_first == false {
				result = append(result, r)
				r.EdbId = ""
				r.Cve = ""
			} else {
				is_first = false
			}
			r.EdbId = edbid
		} else if strings.Contains(td_item_str, "CVE-") {
			cve := strings.TrimLeft(td_item_str, " ")
			cve = strings.Replace(cve, "CVE-", "", -1)
			cve = strings.Replace(cve, "\n", "", -1)
			r.Cve = cve
		} else {
			td_item_str = ""
		}
	})
	result = append(result, r)
	return result, nil
}
